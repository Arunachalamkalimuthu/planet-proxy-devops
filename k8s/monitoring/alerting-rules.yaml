apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: monitoring
data:
  alerts.yml: |
    groups:
      - name: planet-proxy-alerts
        rules:
          # High CPU usage
          - alert: HighCPUUsage
            expr: |
              sum(rate(container_cpu_usage_seconds_total{namespace=~"beta|production", container!=""}[5m])) by (pod) > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage detected"
              description: "Pod {{ $labels.pod }} CPU usage is above 80% for 5 minutes"

          # High Memory usage
          - alert: HighMemoryUsage
            expr: |
              sum(container_memory_usage_bytes{namespace=~"beta|production", container!=""}) by (pod)
              / sum(container_spec_memory_limit_bytes{namespace=~"beta|production", container!=""}) by (pod) > 0.85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage detected"
              description: "Pod {{ $labels.pod }} memory usage is above 85%"

          # Pod not ready
          - alert: PodNotReady
            expr: |
              kube_pod_status_ready{namespace=~"beta|production", condition="true"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pod not ready"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is not ready"

          # High error rate
          - alert: HighErrorRate
            expr: |
              sum(rate(http_requests_total{namespace=~"beta|production", status_code=~"5.."}[5m]))
              / sum(rate(http_requests_total{namespace=~"beta|production"}[5m])) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High HTTP error rate"
              description: "Error rate is above 5% for 5 minutes"

          # Pod restart
          - alert: PodRestarting
            expr: |
              increase(kube_pod_container_status_restarts_total{namespace=~"beta|production"}[1h]) > 3
            labels:
              severity: warning
            annotations:
              summary: "Pod restarting frequently"
              description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last hour"

          # No pods running
          - alert: NoPodRunning
            expr: |
              absent(kube_pod_status_phase{namespace="production", phase="Running"})
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "No pods running in production"
              description: "There are no running pods in production namespace"
