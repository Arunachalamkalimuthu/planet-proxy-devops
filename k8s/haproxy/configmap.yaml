apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: haproxy
  labels:
    app.kubernetes.io/name: haproxy
    app.kubernetes.io/component: load-balancer
    environment: production
data:
  haproxy.cfg: |
    #---------------------------------------------------------------------
    # HAProxy Configuration - Production Environment
    # Planet Proxy Application Load Balancer
    #---------------------------------------------------------------------
    global
        log stdout format raw local0 info
        maxconn 100000
        tune.ssl.default-dh-param 4096
        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    #---------------------------------------------------------------------
    # Default settings
    #---------------------------------------------------------------------
    defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        option  http-server-close
        option  forwardfor except 127.0.0.0/8
        option  redispatch
        retries 3
        timeout http-request    10s
        timeout queue           1m
        timeout connect         10s
        timeout client          2m
        timeout server          2m
        timeout http-keep-alive 10s
        timeout check           10s
        maxconn 20000
        default-server init-addr last,libc,none

    #---------------------------------------------------------------------
    # Stats endpoint for monitoring
    #---------------------------------------------------------------------
    frontend stats
        bind *:8404
        mode http
        stats enable
        stats uri /stats
        stats refresh 10s
        stats admin if LOCALHOST
        http-request use-service prometheus-exporter if { path /metrics }

    #---------------------------------------------------------------------
    # Health check endpoint
    #---------------------------------------------------------------------
    frontend health
        bind *:8405
        mode http
        monitor-uri /health
        option httplog

    #---------------------------------------------------------------------
    # Main HTTP Frontend - Production
    #---------------------------------------------------------------------
    frontend http_front
        bind *:80
        mode http

        # Production security headers
        http-response set-header X-Frame-Options DENY
        http-response set-header X-Content-Type-Options nosniff
        http-response set-header X-XSS-Protection "1; mode=block"
        http-response set-header Referrer-Policy strict-origin-when-cross-origin
        http-response set-header Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # Remove server version info
        http-response del-header Server
        http-response set-header Server "HAProxy"

        # Request ID for tracing
        unique-id-format %{+X}o\ %ci:%cp_%fi:%fp_%Ts_%rt:%pid
        unique-id-header X-Request-ID

        # ACLs for routing
        acl is_gateway_path path_beg /gateway
        acl is_api_path path_beg /api
        acl is_health_path path /health

        # Rate limiting (500 req/10s per IP)
        stick-table type ip size 200k expire 30s store http_req_rate(10s),conn_cur,bytes_out_rate(10s)
        http-request track-sc0 src
        http-request deny deny_status 429 if { sc_http_req_rate(0) gt 500 }

        # Connection limit per IP (max 200 concurrent)
        http-request deny deny_status 429 if { sc_conn_cur(0) gt 200 }

        # Route gateway requests with URL rewrite
        http-request set-path /api/peer/1%[path,regsub(^/gateway,)] if is_gateway_path

        # Use production backend
        default_backend planet_proxy_production

    #---------------------------------------------------------------------
    # Production Backend - Planet Proxy Application
    #---------------------------------------------------------------------
    backend planet_proxy_production
        mode http
        balance roundrobin
        option httpchk GET /health
        http-check expect status 200

        # Connection settings
        timeout connect 5s
        timeout server 120s

        # Enable keep-alive to backend
        option http-keep-alive

        # Circuit breaker settings
        default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

        # Retry on connection errors
        retry-on conn-failure empty-response response-timeout

        # Backend servers (Kubernetes service)
        server-template prod-planet-proxy 20 prod-planet-proxy-service.production.svc.cluster.local:80 check resolvers dns resolve-prefer ipv4

    #---------------------------------------------------------------------
    # DNS Resolvers for Kubernetes service discovery
    #---------------------------------------------------------------------
    resolvers dns
        nameserver coredns kube-dns.kube-system.svc.cluster.local:53
        accepted_payload_size 8192
        resolve_retries 3
        timeout resolve 1s
        timeout retry 1s
        hold valid 10s
        hold other 30s
        hold refused 30s
        hold nx 30s
        hold timeout 30s
